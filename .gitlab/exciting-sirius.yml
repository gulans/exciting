# exciting calling Sirius C++ library
#
# Sirius builds in the pipeline to allow continuious integration of
# upstream API changes. Docker image contains all dependencies.
#
# Unlike the other CI build chains, this is based on Ubuntu focal.
# GCC8 (default on debian buster) C++ compiler is (probably) too old
# to support the C++ features required by Sirius.
# One could have used debian buster + install all dependencies with spack,
# but using a mix of apt-get (for GCC and MPICH) and spack results in faster
# built times.

build:ubuntu-focal-sirius-gcc9-mpich-3.3.2-mkl:
  image: gitdocker.physik.hu-berlin.de/sol/exciting:sirius-cpu-dependencies-may2023
  stage: build
  except:
   changes:
     - "tools/exciting_tools/*"
  tags:
    - docker
  script:
    # Use spack env (in this mode, exports variables)
    - eval /spack/bin/spack env activate --sh $SIRIUS_ENV
    # Check expected docker env vars are defined from the base image
    - echo "Compiling exciting in the spack env, defined in ${SIRIUS_ENV}"
    - echo "Sirius built with the specification ${SPEC}"
    # Build sirius
    - /spack/bin/spack compiler find && /spack/bin/spack -e $SIRIUS_ENV install $SPEC
    # Build exciting, linked to sirius
    - cp build/platforms/make.inc.sirius build/make.inc
    - /spack/bin/spack build-env ${SPEC} -- make mpiandsmp -j 4
  artifacts:
    paths:
      - bin/exciting_mpismp
      - build/make.inc
    expire_in: 5 hrs

test-ubuntu-focal-sirius-gcc9-mpich-3.3.2-mkl:
  image: gitdocker.physik.hu-berlin.de/sol/exciting:sirius-cpu-dependencies-may2023
  stage: test
  except:
   changes:
     - "tools/exciting_tools/*"
  dependencies:
    - build:ubuntu-focal-sirius-gcc9-mpich-3.3.2-mkl
    - python:excitingtools-python-3.7
    - python:regressionframework-python-3.7
  tags:
    - docker
  script:
    # Run exciting unit tests
    - python3 -m pip install --upgrade pip setuptools
    - pip3 install tools/exciting_tools
    # Set GROUPs to run 
    - cd test
    # In this case, ONLY run tests with GROUPS tag: SIRIUS
    - python3 set_groups.py -file defaults_config.yml -groups SIRIUS
    # Run exciting-SIRIUS application tests
    - python3 runtest.py -e exciting_mpismp
